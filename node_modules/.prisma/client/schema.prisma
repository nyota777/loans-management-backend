generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id                     String         @id @default(uuid())
  fullName               String         @map("fullName")
  email                  String         @unique
  phoneNumber            String         @unique
  passwordHash           String         @map("passwordHash")
  isActive               Boolean        @map("is_active")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  confirmedPayments      Payment[]
  confirmedContributions Contribution[]

  @@map("admins")
}

model Member {
  id                 String   @id @default(uuid())
  fullName           String   @map("fullName")
  phoneNumber        String   @unique @map("phoneNumber")
  idNumber           String   @unique @map("idNumber")
  totalContributions Float    @map("totalContributions")
  isActive           Boolean  @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  loans         Loan[]
  contributions Contribution[]

  @@map("members")
}

model Loan {
  id                 String   @id @default(uuid())
  memberId           String   @map("memberId")
  type               LoanType @default(NORMAL) @map("type")
  principalAmount    Float    @map("principalAmount")
  interestRate       Float    @map("interestRate")
  loanDurationMonths Int      @map("loanDurationMonths")
  interestAmount     Float    @map("interestAmount")
  totalPayable       Float    @map("totalPayable")
  monthlyInstallment Float    @map("monthlyInstallment")
  remainingBalance   Float    @map("remainingBalance")
  startDate          DateTime @map("startDate")
  expectedEndDate    DateTime @map("expectedEndDate")
  status             String
  createdAt          DateTime @default(now()) @map("created_at")

  member   Member    @relation(fields: [memberId], references: [id])
  payments Payment[]

  @@map("loans")
}

enum LoanType {
  NORMAL
  EMERGENCY
}

enum PaymentMethod {
  MPESA
  CASH
  BANK
}

model Payment {
  id               String   @id @default(uuid())
  loanId           String   @map("loanId")
  amountPaid       Float    @map("amountPaid")
  paymentDate      DateTime @map("paymentDate")
  remainingBalance Float    @map("remainingBalance")
  paymentNumber    Int      @map("paymentNumber")
  isLate           Boolean  @map("isLate")
  penaltyAmount    Float    @map("penaltyAmount")

  method             PaymentMethod @map("method")
  referenceCode      String?       @unique @map("referenceCode")
  isConfirmed        Boolean       @default(false) @map("isConfirmed")
  confirmedAt        DateTime?     @map("confirmedAt")
  confirmedByAdminId String?       @map("confirmedByAdminId")

  loan        Loan   @relation(fields: [loanId], references: [id])
  confirmedBy Admin? @relation(fields: [confirmedByAdminId], references: [id])

  @@map("payments")
}

model Contribution {
  id                 String        @id @default(uuid())
  memberId           String        @map("memberId")
  amount             Float         @map("amount")
  date               DateTime      @map("date")
  method             PaymentMethod @map("method")
  referenceCode      String?       @unique @map("referenceCode")
  isConfirmed        Boolean       @default(false) @map("isConfirmed")
  confirmedAt        DateTime?     @map("confirmedAt")
  confirmedByAdminId String?       @map("confirmedByAdminId")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  member      Member @relation(fields: [memberId], references: [id])
  confirmedBy Admin? @relation(fields: [confirmedByAdminId], references: [id])

  @@map("contributions")
}
